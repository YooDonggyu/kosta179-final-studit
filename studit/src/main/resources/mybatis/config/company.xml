<?xml version="1.0" encoding="UTF-8"?>
<!-- Sql Mapper -->
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="company">

	<!--*** resultMap ***-->
	<resultMap type="companyVO" id="companyMap">
		<result column="member_email" property="memberVO.memberEmail"/>
		<result column="company_no" property="companyNo"/>
		<result column="profile_path" property="profilePath"/>
	</resultMap>
	
	<resultMap type="studyRoomVO" id="studyRoomMap">
		<result column="company_no" property="companyVO.companyNo"/>
		<result column="companyName" property="companyVO.name"/>
		<result column="open" property="companyVO.open"/>
		<result column="close" property="companyVO.close"/>
		<result column="holiday" property="companyVO.holiday"/>
	</resultMap>
	
	<resultMap type="studyRoomConditionVO" id="studyRoomConditionMap">
		<result column="member_email" property="memberVO.memberEmail"/>
		<result column="name" property="memberVO.name"/>
		<result column="phone" property="memberVO.phone"/>
		<result column="studyroom_no" property="studyRoomVO.studyRoomNo"/>
		<result column="roomName" property="studyRoomVO.name"/>
		<result column="capacity" property="studyRoomVO.capacity"/>
		<!-- <result column="studyroom_condition_no" property="studyRoomConditionNo"/> -->
	</resultMap>
	
	<resultMap type="companyVO" id="comMap" extends="companyMap">
		<result column="memberName" property="memberVO.name"/>
	</resultMap>
	<!--*** resultMap ***-->
	
	<!-- 
		  회원 이메일로 승인대기중인 예약건수 조회
		 @author 송용준 
		 @param memberEmail 회원 이메일
		 @return string 승인대기중인 예약건수 
	-->
	<select id="findWaitReservationByEmail" resultType="string">
		select count(*)
		from (
				select s.studyroom_no
				from company c, studyroom s
				where c.company_no = s.company_no
				and c.member_email = #{value}
			)st,studyroom_condition sc
		where sc.studyroom_no = st.studyroom_no and sc.state='예약대기' 
	</select>
	
	<!-- 
		 등록이 승인된 스터디 룸의 addr1 값 조회
		 @author 송용준 
		 @return string company 테이블의 addr1 값
	-->
	<select id="readFirstAddr" resultType="string">
		select distinct addr1
		from company
		where state='승인'
	</select>
	
	<!-- 
		 등록이 승인된 업체 목록을 불러온다
		 @author 송용준 
		 @return companyVO 등록이 승인된 업체 객체
	-->
	<select id="readAllCompany" resultType="companyVO">
		select company_no, name, addr1, addr2, addr3, intro, profile_path
		from company
		where state='승인'
		order by regdate desc
	</select>
	<!-- 
		 등록이 승인된 업체 목록들의 해쉬태그를 불러온다
		 @author 송용준 
		 @return map 해쉬태그 정보를 담은 map 객체
	-->
	<select id="readAllHashTag" resultType="map">
		select h.content, h.company_no
		from hashtag h, company c
		where c.company_no=h.company_no and c.state='승인'
	</select>
	<!-- 
		선택된 addr1을 가진 업체들의 addr2를 불러온다
		 @author 송용준 
		 @return string company 테이블의 addr2 값
	-->
	<select id="findSecondAddressListByFirstAddressName" parameterType="string" resultType="string">
		select distinct addr2
		from company
		where addr1=#{value} and state='승인'
	</select>
	<!-- 
		 선택된 addr2을 가진 업체들의 addr3를 불러온다
		 @author 송용준 
		 @return string company 테이블의 addr3 값
	-->
	<select id="findThirdAddressListBySecondAddressName" parameterType="string" resultType="string">
		select distinct addr3
		from company
		where addr2=#{value} and state='승인'
	</select>
	
	  <!-- 
      회원 이메일로 업체 정보 조회
      @author 김유란
      @param memberEmail 업체로 등록된 회원 이메일
      @return companyVO 
    -->
   <select id="findCompanyByMemberEmail" resultMap="companyMap">
   	select c.company_no, c.name, c.addr1, c.addr2, c.addr3, c.addr4, c.primary_addr, c.detail_addr, 
	c.tel, c.license, c.regdate, c.profile_path, c.intro, c.state, c.open, c.close, c.holiday, c.url, m.member_email
	from company c, member m
	where c.member_email=#{value} and c.member_email=m.member_email 
   </select>
  
   <!-- 
	  업체 번호로 스터디룸 정보 조회
      @author 김유란
      @param companyNo 업체 식별 번호
      @return studyRoomVO
    -->
  <select id="findStudyRoomByCompanyNo" resultMap="studyRoomMap">
  	select s.studyroom_no, s.name, s.capacity, s.price, s.content, c.name as companyName, c.company_no, c.open, c.close, c.holiday
	from studyroom s, company c
	where s.company_no=c.company_no and c.company_no=#{value}
   </select> 
   
   <!-- 
         스터디룸 번호로 특정 월의 스터디룸 예약 현황  조회
      @author 김유란
      @param companyNo 스터디룸 식별 번호
      @return studyRoomConditionVO
    -->
   <select id="findStudyRoomConditionByCompanyNoAndMonth" resultMap="studyRoomConditionMap" parameterType="map">
   	select sc.studyroom_condition_no, sc.member_email, to_char(sc.use_date, 'YYYY-MM-DD') use_date, sc.start_time, sc.end_time, sc.state, s.studyroom_no, s.name as roomName, m.name
	from studyroom s, studyroom_condition sc, member m
	where s.studyroom_no=sc.studyroom_no and m.member_email=sc.member_email and s.company_no=#{companyNo} 
		and use_date between to_date(#{startDate}, 'YYYY-MM-DD') and to_date(#{endDate}, 'YYYY-MM-DD') 
   </select>
   

	<!-- 
		스터디룸 예약 현황  수정
		@author 김유란
		@param studyRoomConditionNo 스터디룸 예약 식별 번호
		@return studyRoomConditionVO
    -->
	<update id="updatStudyRoomCondition" parameterType="studyRoomConditionVO">
		update studyroom_condition 
		set use_date=to_date(#{useDate}, 'YYYY-MM-DD'), start_time=#{startTime}, end_time=#{endTime}, state=#{state}
		where studyroom_condition_no=#{studyRoomConditionNo} 
	</update>
	
	<!-- 
		업체 영업일 조회
		@author 김유란
    -->
	<select id="findBusinessDayByCompanyNo" resultType="string">
		select day from com_business_day where company_no=#{value}
	</select>
	
	<select id="findCompanyListByAddress" parameterType="map" resultType="companyVO">
		select com.company_no, com.name, com.addr1, com.addr2, com.addr3, com.intro, com.profile_path 
		from company com, (
			select distinct c.company_no as company_no
			from company c, hashtag h
			<where>
				 c.state='승인'
				<if test="firstAddr != null">
					and c.addr1=#{firstAddr}
				</if>
				<if test="secondAddr != null">
					and c.addr2=#{secondAddr}
				</if>
				<if test="thirdAddr != null">
					and c.addr3=#{thirdAddr}
				</if>
				<if test="keywordORhashtag != null">
					and c.company_no=h.company_no and c.name || h.content like '%'||#{keywordORhashtag}||'%'
				</if> 
			</where>
		) dc
		where com.company_no = dc.company_no 
		order by regdate desc
		
	</select>
	
   <!-- 
		업체 등록 시 등록되는 해시태그들을 insert하는 쿼리
		@author 변태섭
		@param map 입력된 해시태그와 해당 업체 번호
    -->
   <insert id="registerHashtag" parameterType="map" >
   		insert into hashtag(hashtag_no, content, company_no)
   		values(hashtag_seq.nextval, #{tag}, #{companyNo})
   </insert>
   
   
   <!-- 
   		업체 등록 시 등록되는 영업 요일을 insert하는 쿼리
   		@author 변태섭
   		@param map 입력된 요일과 해당 업체 번호
    -->
   <insert id="registerBusinessDay" parameterType="map">
   		insert into com_business_day(com_day_no, day, company_no)
   		values(com_business_day_seq.nextval, #{day}, #{companyNo})
   </insert>
   
   <!-- 
   		업체 등록 시 입력된 업체 데이터를 insert하는 쿼리
   		
   		@author 변태섭
   		@param CompanyVO 업체 정보와 해당 회원의 이메일이 담긴 객체
    -->
   <insert id="registerCompany" parameterType="companyVO">
   		<selectKey keyProperty="companyNo" resultType="int" order="BEFORE">
					select
					company_no_seq.nextval from dual
		</selectKey>
   		insert into company(company_no, name, addr1, addr2, addr3, addr4, primary_addr, detail_addr, tel, license, regdate, profile_path, 
   						  intro, state, open, close, holiday, hit, url, member_email) 
		values (#{companyNo}, #{name}, #{addr1}, #{addr2}, #{addr3}, #{addr4}, 	#{primaryAddr}, #{detailAddr}, #{tel}, #{license}, 
					sysdate, #{profilePath}, #{intro}, '예약대기', #{open}, #{close}, #{holiday}, 0, #{url}, #{memberVO.memberEmail}
					)
   </insert>
   
   <!-- 
   		업체 등록 시 업로드 된 사진들의 경로를 테이블에 insert하는 쿼리
   		@author 변태섭
   		@parma Map 사진들의 경로와 업체 번호를 담은 객체
    -->
   <insert id="registerCompanyPicPath" parameterType="map">
   		insert into com_pic(com_pic_no, path, company_no) 
   		values (com_pic_no_seq.nextval, #{companyPicPath},#{companyNo})
   </insert>
   
   <!-- 
   		사업자 등록 번호 중복 체크를 위해 Count를 받아오는 쿼리
   		@author 변태섭
    -->
   <select id="findCountCompanyByLicense" parameterType="string" resultType="int">
   		select count(*) from company where license = #{value}
   </select>
   
   
   
   
   
   
   <!-- 
   		업체 번호에 따른 업체 정보 반환
   		@author 유동규
    -->
   <select id="findCompanyByCompanyNo" resultMap="comMap">
		select c.company_no, c.name, c.addr1, c.addr2, c.addr3, c.addr4, c.primary_addr, c.detail_addr, c.tel, c.license
				, to_char(c.regdate, 'YYYY-MM-DD') as regdate, c.profile_path, c.intro, c.state, c.open, c.close
				, c.holiday, c.hit, c.url, m.member_email, m.name as memberName
		from company c, member m
		where company_no = #{value} and c.member_email = m.member_email  
   </select>
   
   <!--
   		업체 번호에 따른 업체 사진 경로 반환
   		@author 유동규
    -->
    <select id="findComPicByCompanyNo" resultType="map">
    	select com_pic_no, path, company_no
    	from com_pic
    	where company_no = #{value}
    </select>
	
	
	<!-- 
		업체 번호에 따른 해시태그 가져오기
		@author 유동규
	 -->
	 <select id="findHashTagByCompanyNo" resultType="map">
	 	select hashtag_no, content, company_no
	 	from hashtag
    	where company_no = #{value}
	 </select>
	 
	 <!-- 
		스터디룸 예약 현황 월별 건수 조회
		@author 김유란
	 -->
	 <select id="findStudyRoomConditionCountByMonth" resultType="map" parameterType="string">
	 	select to_char(use_date, 'YYYY-MM') m, count(*) count, state 
		from (select s.studyroom_no, sc.use_date, sc.state
		from studyroom s, company c, studyroom_condition sc
		where s.company_no=c.company_no and s.studyroom_no=sc.studyroom_no 
		and c.company_no=#{value})
		group by to_char(use_date, 'YYYY-MM'), state 
	 </select>
   
</mapper>
 
 
 
 
 
 
 
 
 
 
 
